<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrar Categorías</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">

  <h2 class="mb-4">Administrar Categorías</h2>

  <!-- Formulario -->
  <form id="formCategoria" class="row g-3 mb-4 border p-3 rounded shadow-sm">
    <div class="col-md-6">
      <label for="nombre" class="form-label">Nombre de Categoría</label>
      <input type="text" id="nombre" class="form-control" required />
    </div>
    <div class="col-md-3">
      <label for="visible" class="form-label">Visible</label>
      <select id="visible" class="form-select">
        <option value="1">Sí</option>
        <option value="0">No</option>
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Guardar</button>
    </div>
  </form>

  <!-- Tabla -->
  <table class="table table-bordered">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Visible</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaCategorias"></tbody>
  </table>

  <script>
    let idEnEdicion = null;

    async function cargarCategorias() {
      const res = await fetch('/categorias');
      const data = await res.json();
      const tbody = document.getElementById('tablaCategorias');
      tbody.innerHTML = '';
      data.forEach(cat => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${cat.id}</td>
          <td>${cat.nombre}</td>
          <td>${cat.visible == 1 ? 'Sí' : 'No'}</td>
          <td>
            <button class="btn btn-sm btn-warning me-2" onclick="editar(${cat.id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="eliminar(${cat.id})">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function editar(id) {
      const res = await fetch(`/categoria?id=${id}`);
      const cat = await res.json();
      document.getElementById('nombre').value = cat.nombre;
      document.getElementById('visible').value = cat.visible;
      idEnEdicion = id;
    }

    async function eliminar(id) {
      if (confirm("¿Eliminar esta categoría?")) {
        await fetch(`/categoria?id=${id}`, { method: 'DELETE' });
        await cargarCategorias();
      }
    }

    document.getElementById('formCategoria').addEventListener('submit', async e => {
      e.preventDefault();
      const data = {
        nombre: document.getElementById('nombre').value.trim(),
        visible: parseInt(document.getElementById('visible').value)
      };
      const url = idEnEdicion ? `/categoria?id=${idEnEdicion}` : '/categoria';
      const method = idEnEdicion ? 'PUT' : 'POST';
      await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      e.target.reset();
      idEnEdicion = null;
      await cargarCategorias();
    });

    window.addEventListener('DOMContentLoaded', cargarCategorias);
  </script>

</body>
</html>
