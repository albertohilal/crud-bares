<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRUD Productos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
</head>
<body class="container mt-4">
  <h2 class="mb-4 text-center">Formulario de Productos</h2>

  <form id="productoForm">
    <input type="hidden" id="productoId">

    <div class="mb-3">
      <label for="nombre" class="form-label">Nombre del producto</label>
      <input type="text" id="nombre" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="precio" class="form-label">Precio</label>
      <input type="number" id="precio" class="form-control" step="0.01" required>
    </div>

    <div class="mb-3">
      <label for="descripcion" class="form-label">Descripción</label>
      <input type="text" id="descripcion" class="form-control">
    </div>

    <div class="mb-3">
      <label for="categoria" class="form-label">Categoría</label>
      <select class="form-select" id="categoria" required>
        <option value="">-- Seleccionar --</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="bodega" class="form-label">Bodega</label>
      <select class="form-select" id="bodega">
        <option value="">-- Seleccionar --</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="subtipo" class="form-label">Subtipo de Vino</label>
      <select class="form-select" id="subtipo">
        <option value="">-- Seleccionar --</option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary">Guardar</button>
  </form>

  <hr>

  <h4 class="mt-5">Listado de Productos</h4>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>ID</th><th>Nombre</th><th>Categoría</th><th>Bodega</th><th>Subtipo</th><th>Precio</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="productosBody"></tbody>
  </table>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get("slug");

    async function cargarSelect(url, selectId, valueField, textField) {
      try {
        const res = await fetch(url);
        const data = await res.json();
        const select = document.getElementById(selectId);
        select.innerHTML = `<option value="">-- Seleccionar --</option>`;
        data.forEach(item => {
          const opt = document.createElement("option");
          opt.value = item[valueField];
          opt.textContent = item[textField];
          select.appendChild(opt);
        });
      } catch (err) {
        console.error(`Error al cargar ${selectId}:`, err);
      }
    }

    async function listarProductos() {
      const res = await fetch(`/productos?slug=${slug}`);
      const productos = await res.json();
      const tbody = document.getElementById("productosBody");
      tbody.innerHTML = "";
      productos.forEach(p => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${p.id}</td>
          <td>${p.nombre_producto}</td>
          <td>${p.categoria || "-"}</td>
          <td>${p.bodega_id || "-"}</td>
          <td>${p.subcategoria_tipo_id || "-"}</td>
          <td>$${parseFloat(p.precio).toFixed(2)}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="editarProducto(${p.id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${p.id})">Eliminar</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function editarProducto(id) {
      const res = await fetch(`/productos/${id}`);
      const p = await res.json();
      document.getElementById("productoId").value = p.id;
      document.getElementById("nombre").value = p.nombre_producto;
      document.getElementById("precio").value = p.precio;
      document.getElementById("descripcion").value = p.descripcion || "";
      document.getElementById("categoria").value = p.categoria || "";
      document.getElementById("bodega").value = p.bodega_id || "";
      document.getElementById("subtipo").value = p.subcategoria_tipo_id || "";
    }

    async function eliminarProducto(id) {
      if (!confirm("¿Eliminar este producto?")) return;
      await fetch(`/productos/${id}`, { method: "DELETE" });
      listarProductos();
    }

    document.getElementById("productoForm").addEventListener("submit", async e => {
      e.preventDefault();
      const id = document.getElementById("productoId").value;

      const producto = {
        nombre_producto: document.getElementById("nombre").value,
        precio: parseFloat(document.getElementById("precio").value),
        descripcion: document.getElementById("descripcion").value,
        categoria: document.getElementById("categoria").value,
        cliente_slug: slug,
        precio_chico: null,
        precio_grande: null,
        visible: 1,
        subcategoria_tipo_id: document.getElementById("subtipo").value || null,
        bodega_id: document.getElementById("bodega").value || null,
      };

      const metodo = id ? "PUT" : "POST";
      const url = id ? `/productos/${id}` : "/productos";

      await fetch(url, {
        method: metodo,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(producto),
      });

      document.getElementById("productoForm").reset();
      document.getElementById("productoId").value = "";
      listarProductos();
    });

    cargarSelect("/categorias", "categoria", "nombre", "nombre");
    cargarSelect("/bodegas", "bodega", "id", "nombre");
    cargarSelect("/subtipos", "subtipo", "id", "nombre");
    listarProductos();
  </script>
</body>
</html>
